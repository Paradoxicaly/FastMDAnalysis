.. currentmodule:: FastMDAnalysis.analysis.hbonds

Hydrogen Bonds
==============

The :class:`HBondsAnalysis` module enumerates hydrogen bonds (H-bonds) across a
trajectory using the Baker–Hubbard geometric criteria described in Section 3.4
of the manuscript. It produces both a per-frame count and the raw donor–acceptor
assignment list for downstream filtering.

Theory
------

An H-bond exists when the donor–hydrogen–acceptor triplet satisfies two
thresholds:

.. math::

   d_{\mathrm{D\cdots A}} < 0.35\,\text{nm} \quad \text{and} \quad \angle \mathrm{HDA} > 120^{\circ}

These defaults match :func:`mdtraj.baker_hubbard`. The module tallies how many
bonds satisfy both criteria in each frame.

Implementation Highlights
-------------------------

- Accepts optional atom selections to restrict the search (for example,
  ``"protein"``); the selection is applied before H-bond detection.
- Stores the integer counts in ``self.data`` (one column per frame) and exposes
  the raw triplets through ``self.results["raw_hbonds"]``.
- :meth:`HBondsAnalysis.plot` produces a trace of counts per frame; unlike other
  analyses it is only called automatically when triggered via the CLI wrapper.

Usage
-----

**API**

.. code-block:: python

   import mdtraj as md
   from fastmdanalysis import FastMDAnalysis

   traj = md.load("traj.dcd", top="top.pdb")
   traj.topology.create_standard_bonds()
   fastmda = FastMDAnalysis(traj)
   hbonds = fastmda.hbonds()
   results = hbonds.run()
   hbonds.plot(color="#d62728", title="Protein H-Bonds")

**CLI**

.. code-block:: bash

   fastmda hbonds -traj traj.dcd -top top.pdb --atoms "protein" -o analysis/hbonds

Outputs
-------

- ``hbonds_output/hbonds_counts.dat`` — single column with the number of H-bonds per frame.
- ``hbonds_output/hbonds.png`` — timeline of counts generated by :meth:`HBondsAnalysis.plot`.
- ``hbonds_output/hbonds.log`` — log file capturing donor/acceptor statistics.
- ``results["raw_hbonds"]`` — in-memory array of tuples ``(frame, donor, acceptor, hydrogen)`` for advanced analysis.

Interpretation Tips
-------------------

- Stable secondary structure maintains narrow fluctuations; steep drops often
  correspond to unfolding or broken salt bridges.
- Overlay the H-bond counts with :doc:`ss` assignments to confirm helix or sheet
  disruption during the simulation window.

Troubleshooting
---------------

- If the counts are consistently zero, ensure the topology includes bond
  definitions. For MDTraj-loaded PDBs call ``topology.create_standard_bonds()``
  before passing the trajectory into :class:`FastMDAnalysis`.
- ``AnalysisError: No atoms selected`` indicates the selection returned no
  indices—double-check residue labels and chain identifiers.
- The Baker–Hubbard parameters are fixed; for custom cutoffs, post-process the
  ``raw_hbonds`` array rather than modifying the core module.
