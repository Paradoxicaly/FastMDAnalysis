.. currentmodule:: FastMDAnalysis.analysis.rmsd

RMSD Analysis
=============

The :class:`RMSDAnalysis` module measures the structural drift of a trajectory by
tracking the root-mean-square deviation (RMSD) of each frame relative to a
single reference conformation. It mirrors Section 3.1 of the manuscript and is
typically the first diagnostic users run after loading a trajectory.

Theory
------

Given Cartesian coordinates :math:`\mathbf{r}_i(t)` for atom :math:`i` in frame
:math:`t` and the reference coordinates :math:`\mathbf{r}_i^{\text{ref}}`, the
module computes

.. math::

   \mathrm{RMSD}(t) = \sqrt{\frac{1}{N} \sum_{i=1}^{N} \left\| \mathbf{r}_i(t) - \mathbf{r}_i^{\text{ref}} \right\|^2 }

The implementation delegates to :func:`mdtraj.rmsd`, which performs Kabsch
alignment on the selected atoms before calculating Euclidean distances.

Implementation Highlights
-------------------------

- Inherits from :class:`~FastMDAnalysis.analysis.base.BaseAnalysis`, so
  ``run()`` stores data under ``self.data`` and ``plot()`` writes PNGs to
  ``rmsd_output`` (or a user-specified directory).
- Supports optional atom selections via MDTraj syntax (for example,
  ``"protein and name CA"``); the reference frame is sliced using the same mask
  to ensure consistency.
- Ensures the reference frame index respects any global or per-analysis frame
  selection applied when the parent :class:`~FastMDAnalysis.FastMDAnalysis`
  instance was created.

Usage
-----

**API**

.. code-block:: python

   from FastMDAnalysis import FastMDAnalysis

   fastmda = FastMDAnalysis("traj.dcd", "top.pdb", frames=(0, -1, 5))
   rmsd = fastmda.rmsd(ref=0, atoms="protein and name CA", output="analysis/rmsd")
   results = rmsd.run()
   png_path = rmsd.plot(title="Backbone RMSD")

**CLI**

.. code-block:: bash

   fastmda rmsd -traj traj.dcd -top top.pdb --ref 0 --atoms "protein and name CA" \
      --frames 0,-1,5 -o analysis/rmsd

Outputs
-------

- ``rmsd_output/rmsd.dat`` — two-column text file with frame index and RMSD
   (nm).
- ``rmsd_output/rmsd.png`` — default line plot generated by
   :meth:`RMSDAnalysis.plot`.
- ``rmsd_output/rmsd.log`` — log file captured by the CLI launcher.

Interpretation Tips
-------------------

- Stable proteins should plateau quickly; monotonically increasing RMSD values
   often indicate unfolding or unresolved equilibration.
- Combine with :doc:`rmsf` to localise regions that contribute the most to the
   observed drift.

Troubleshooting
---------------

- ``AnalysisError: No atoms selected`` means the selection string did not match
   any atoms in the topology. Verify naming conventions in the input PDB/PSF.
- If ``ref`` points beyond the effective frame window (after applying
   ``--frames``), the analysis raises an ``IndexError``. Either adjust the frame
   tuple or choose another reference.
- RMSD is reported in nanometres because MDTraj operates in SI units; rescale
   manually if your downstream tooling expects Ångström.
